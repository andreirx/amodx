# tools/mcp-server — MAP.md

## Role in the System

A Model Context Protocol (MCP) server that integrates AMODX with Claude Desktop. Allows Claude to manage tenants, create/edit pages with blocks, manage products, moderate comments, and apply themes — all through natural language. Communicates with the backend via HTTP API using a master API key.

**Depends on:** backend (HTTP API)

## Internal Structure

```
src/
└── index.ts          # MCP server: all 22 tools, block schemas, API helpers (~1029 lines)

setup.ts              # Configures Claude Desktop to use this server
.env                  # AMODX_API_URL + AMODX_API_KEY (generated by post-deploy)
package.json
tsconfig.json
```

## Server Configuration

- **Transport:** Stdio (communicates via stdin/stdout pipes with Claude Desktop)
- **Server name:** `AMODX-Bridge` v2.1.0
- **SDK:** `@modelcontextprotocol/sdk` v1.24.3
- **Auth:** master API key in `x-api-key` header + `Authorization: Bearer robot`
- **Tenant scoping:** `x-tenant-id` header per request

## Tools (26 total)

### Site Management
| Tool | Method | Purpose |
|------|--------|---------|
| `list_tenants` | GET /tenant | List all sites |
| `create_tenant` | POST /tenant | Create new site |

### Strategy & Context
| Tool | Method | Purpose |
|------|--------|---------|
| `list_context` | GET /context | List strategy docs for tenant |
| `create_context` | POST /context | Create strategy document |
| `read_context` | GET /context/{id} | Read full context doc |

### Content & Blocks
| Tool | Method | Purpose |
|------|--------|---------|
| `list_content` | GET /content | List all pages |
| `read_page` | GET /content/{id} | Read full page with blocks |
| `create_page` | POST /content | Create blank draft page |
| `update_page` | PUT /content/{id} | Full page update (blocks JSON replaces entire content) |
| `add_block` | PUT /content/{id} | Append a single block to existing page |
| `get_block_schemas` | (local) | Returns attribute schemas for all 17 block types |
| `list_tags` | GET /content (extract) | List all tags used across pages |

### Products
| Tool | Method | Purpose |
|------|--------|---------|
| `list_products` | GET /products | List all products |
| `create_product` | POST /products | Create new product |

### Assets
| Tool | Method | Purpose |
|------|--------|---------|
| `list_assets` | GET /assets | List uploaded files (top 20) |

### Comments
| Tool | Method | Purpose |
|------|--------|---------|
| `list_comments` | GET /comments | List comments for moderation |
| `moderate_comment` | POST /comments/moderate | Approve/spam/hide/delete comment |

### Signals (Outbound Leads)
| Tool | Method | Purpose |
|------|--------|---------|
| `search_web` | Serper.dev API | Web search for prospects (requires SERPER_API_KEY) |
| `scrape_url` | HTTP GET + cheerio | Extract text content from a URL |
| `save_signal` | POST /signals | Save an analyzed outbound lead signal |
| `list_signals` | GET /signals | List all signals for a tenant |

### Themes
| Tool | Method | Purpose |
|------|--------|---------|
| `list_themes` | GET /themes | List available themes |
| `create_theme` | POST /themes | Create custom theme |
| `apply_theme` | PUT /tenant/settings | Apply theme to light or dark mode |

### Reference
| Tool | Method | Purpose |
|------|--------|---------|
| `get_schema` | (local) | Full system documentation and workflow guide |

## Block Types Supported

The `add_block` tool supports 17 block types: hero, pricing, contact, image, video, leadmagnet, features, cta, testimonials, columns, table, paragraph, heading, html, faq, postGrid, carousel.

`get_block_schemas` returns detailed attribute definitions with descriptions and examples for each type.

## Setup

```bash
cd tools/mcp-server
npm run build          # Compile TypeScript
npm run setup          # Inject into Claude Desktop config
```

`setup.ts` locates the Claude Desktop config file (`~/Library/Application Support/Claude/claude_desktop_config.json` on macOS) and writes the server entry with environment variables.

## Key Patterns

- **Full page replacement:** `update_page` sends the complete blocks array — Claude must read the page first, modify, then send back the full array
- **Incremental editing:** `add_block` appends a single block without touching existing content
- **Error handling:** all tools wrap API calls in try/catch, return `isError: true` with message on failure
- **Schema reference:** `get_block_schemas` and `get_schema` are local-only tools (no API call) that help Claude understand available block types and system workflows
