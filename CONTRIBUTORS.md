# AMODX Developer Guide

This document is for engineers contributing to the AMODX core platform.

---

## üèó System Architecture

### The Six Domains
1.  **The Brain:** `backend/src/context` (DynamoDB Strategy)
2.  **The Cockpit:** `admin/` (React Dashboard)
3.  **The Face:** `renderer/` (Next.js ISR Engine)
4.  **The Bridge:** `tools/mcp-server/` (AI Interface)
5.  **The Gatekeeper:** `infra/lib/auth.ts` (Cognito + Lambda Authorizer)
6.  **The Pulse:** `infra/lib/events.ts` (EventBridge + Async Workers)
7.  **The Plugins:** `packages/plugins` (UI Block Registry)

---

## üîê Authentication & Security

The Backend API is protected by a **Lambda Authorizer**. Every request must have specific headers depending on the actor.

### 1. API Security (Lambda Authorizer)
*   **Humans:** `Authorization: Bearer <Cognito_JWT>` + `x-api-key: web-client`.
*   **Robots/Renderer:** `x-api-key: <MASTER_KEY>` + `Authorization: Bearer robot`.
*   **Public Routes:** `/leads`, `/contact`.

### 2. Asset Security (S3)
*   **Public Assets:** `AssetsBucket`. Served via CloudFront (`d123.cloudfront.net`).
*   **Private Resources:** `PrivateBucket`. No public access. Accessed via **Presigned URLs** generated by the Backend (`GET /resources/:id/download`).

---

## üé® Frontend Architecture

### The Plugin System (Blocks)
We use a split-entry architecture to prevent Next.js from crashing on Tiptap dependencies.
*   `packages/plugins/src/admin.ts`: Exports Editor components (Tiptap).
*   `packages/plugins/src/render.ts`: Exports React components (Standard DOM).

### Global Context Injection
The Renderer injects the Tenant ID into the browser scope so hydrated components (like Contact Forms) know where to send data without prop drilling.
*   **Source:** `renderer/src/components/ThemeInjector.tsx`
*   **Variable:** `window.AMODX_TENANT_ID`

---

## üñº Asset Pipeline (Uploads)

We do not upload files through the API Gateway (payload limits). We use **Signed URLs**.

1.  **Request:** Admin calls `POST /assets` with filename/type.
2.  **Presign:** Backend generates a secure S3 PUT URL.
3.  **Upload:** Frontend uploads binary directly to S3.
4.  **Delivery:** Files are served publicly via CloudFront (`https://assets.domain.com/...`).

---

## üíª Local Development

### 1. Initial Setup
```bash
npm install
npm run build -w @amodx/shared
npm run build -w @amodx/plugins
```

### 2. Deploy Backend
```bash
cd infra
npx cdk deploy
npm run post-deploy # <--- GENERATES .env.local FILES AUTOMATICALLY
```

### 3. Run Admin & Renderer
```bash
# Terminal 1
cd admin && npm run dev

# Terminal 2
cd renderer && npm run dev
```

### 4. Watch Mode
If modifying plugins/shared types:
```bash
# Terminal 3
cd packages/plugins
npm run watch
```

---

## üß© Creating a Plugin (Block)

1.  **Create:** `packages/plugins/src/my-block/` (Schema, Editor, Render, Index).
2.  **Uploads:** If your editor needs to upload files, use the injected `editor.storage.image.uploadFn` (Dependency Injection pattern). Don't import API libs directly.
3.  **Register:** Add to `src/admin.ts` AND `src/render.ts`.
4.  **Build:** `npm run build -w @amodx/plugins` (Required after every change!).
5.  **Deploy:** `cd infra && npx cdk deploy`.

See `packages/plugins/src/` for example implementations.

---

## üì¶ Project Structure

```text
amodx/
‚îú‚îÄ‚îÄ admin/                 # React SPA (Vite)
‚îú‚îÄ‚îÄ backend/               # Lambda Functions
‚îÇ   ‚îú‚îÄ‚îÄ audit/             # Async Workers
‚îÇ   ‚îú‚îÄ‚îÄ content/           # CMS Logic
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ infra/                 # AWS CDK
‚îú‚îÄ‚îÄ packages/
‚îÇ   ‚îú‚îÄ‚îÄ shared/            # Types
‚îÇ   ‚îî‚îÄ‚îÄ plugins/           # UI Block Registry
‚îÇ       ‚îî‚îÄ‚îÄ src/
‚îÇ           ‚îú‚îÄ‚îÄ admin.ts   # Entry point for Admin
‚îÇ           ‚îú‚îÄ‚îÄ render.ts  # Entry point for Renderer
‚îÇ           ‚îú‚îÄ‚îÄ hero/      # Hero Plugin
‚îÇ           ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ renderer/              # Next.js App Router (ISR)
‚îî‚îÄ‚îÄ tools/
    ‚îî‚îÄ‚îÄ mcp-server/        # AI Interface
```
